@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import config.FrontendAppConfig
@import models.SchemeDetail
@import controllers.routes.ListSchemesController

@this(
    main_template: main_template,
    formHelper: FormWithCSRF,
    appConfig: FrontendAppConfig
)

@(
    form: Form[_],
    schemes: List[SchemeDetail],
    psaName: String,
    numberOfSchemes: Int,
    pagination: Int,
    pageNumber: Int,
    pageNumberLinks: Seq[Int],
    numberOfPages: Int
)(implicit
    request: Request[_],
    messages: Messages
)

@msgPrefix = @{
    "messages__schemesOverview__pagination__"
}

@manageRedirectLink = @{
    val href: String = appConfig.pensionSchemeOnlineServiceUrl

    val linkText: String = messages("messages__schemesOverview__manage__redirect__link")

    Html(s"""<a id="manage-link" href="$href">$linkText</a>""")
}

@navLink(linkText: String, pageNumber: Int) = @{
    val id: String = linkText.toLowerCase

    val href: String = controllers.routes.ListSchemesController.onPageLoadWithPageNumber(pageNumber).url

    val ariaLabel: String = messages(s"$msgPrefix${linkText.toLowerCase}__ariaLabel")

    Html(s"""<span class="nav-item"><a id="$id" href="$href" aria-label="$ariaLabel">$linkText</a></span>""")
}

@ariaAttrs(linkNumber: Int) = @{
    val ariaLabelLinkCurrent: String = messages(s"${msgPrefix}pageNumberCurrent__ariaLabel", linkNumber, numberOfPages)

    val ariaLabelLink: String = messages(s"${msgPrefix}pageNumber__ariaLabel", linkNumber, numberOfPages)

    if(linkNumber == pageNumber)
        s"""aria-current="page" aria-label="$ariaLabelLinkCurrent""""
    else
        s"""aria-label="$ariaLabelLink""""
}

@pageNumberLink(linkNumber: Int) = @{
    val id: String = s"pageNumber-$linkNumber"

    val href: String = controllers.routes.ListSchemesController.onPageLoadWithPageNumber(linkNumber).url

    Html(s"""<span class="nav-item"><a id="$id" href="$href" ${ariaAttrs(linkNumber)}>$linkNumber</a></span>""")
}

@paginationText = @{
    messages(
        s"${msgPrefix}text",
        if (pageNumber == 1) pageNumber else ((pageNumber * pagination) - pagination) + 1,
        if (pageNumber == numberOfPages) numberOfSchemes else pageNumber * pagination,
        numberOfSchemes
    )
}

@main_template(
    title = messages("messages__listSchemes__title"),
    bodyClasses = Some("full-width")
) {

    @formHelper(action = ListSchemesController.onSubmit, 'autoComplete -> "off") {
        @components.back_link()

        <div class="grid-row">
            <div class="column-two-thirds">
                @components.heading(headingKey = messages("messages__listSchemes__title"))

                @components.input_text(
                    field = form("searchText"),
                    label = messages("messages__listSchemes__searchText_label"),
                    hint  = Some(messages("messages__listSchemes__searchText_hint"))
                )

                @components.submit_button("site.continue")

                <p>@Html(messages("messages__schemesOverview__manage__redirect__text", manageRedirectLink))</p>
            </div>
        </div>

        @if(schemes.isEmpty) {
            <div class="grid-row">
                <div class="column-two-thirds">
                    <p id="noSchemes">@messages("messages__listSchemes__noSchemes")</p>
                </div>
            </div>
        } else {
            @components.scheme_list(schemes, appConfig)
        }

        @if(numberOfSchemes > pagination) {
            <div class="grid-row">
                <div class="column-two-thirds">
                    <p class="govuk-margin-top-5" id="pagination-text">
                        @paginationText
                    </p>
                    <nav class="govuk-margin-top-5" aria-label="page">
                        @if(pageNumber > 1) {
                            @navLink(
                                linkText = messages(s"${msgPrefix}first"),
                                pageNumber = 1
                            )
                            @navLink(
                                linkText = messages(s"${msgPrefix}prev"),
                                pageNumber = pageNumber - 1
                            )
                        }

                        @for((int, i) <- pageNumberLinks.zipWithIndex) {
                            @pageNumberLink(
                                linkNumber = pageNumberLinks(i)
                            )
                        }

                        @if(pageNumber < numberOfPages) {
                            @navLink(
                                linkText = messages(s"${msgPrefix}next"),
                                pageNumber = pageNumber + 1
                            )
                            @navLink(
                                linkText = messages(s"${msgPrefix}last"),
                                pageNumber = numberOfPages
                            )
                        }
                    </nav>
                </div>
            </div>
        }

        @components.return_link(controllers.routes.SchemesOverviewController.onPageLoad(), Some(psaName))
    }
}